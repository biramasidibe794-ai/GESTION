{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestion des Années</title>

  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">École — Années</a>
    <div>
      <button id="btnAdd" class="btn btn-outline-light">Ajouter une année</button>
    </div>
  </div>
</nav>

<div class="container">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Liste des années</h5>
        <div class="input-group w-50">
          <input id="searchInput" type="text" class="form-control" placeholder="Rechercher (ex: 2024/2025)">
          <button id="searchBtn" class="btn btn-outline-secondary">Rechercher</button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table id="anneeTable" class="table table-striped table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Année</th>
              <th>Statut</th>
              <th>Description</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for annee in annees %}
            <tr data-id="{{ annee.id }}">
              <td>{{ forloop.counter }}</td>
              <td class="annee-label">{{ annee.nom }}</td>
              <td class="annee-statut">{% if annee.active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactif</span>{% endif %}</td>
              <td class="annee-desc">{{ annee.description|default:"—" }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary btn-edit">Modifier</button>
                <button class="btn btn-sm btn-outline-danger btn-delete">Supprimer</button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">Aucune année trouvée.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- Modal : Ajouter / Modifier -->
<div class="modal fade" id="anneeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="anneeForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Ajouter une année</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <input type="hidden" id="anneeId" name="id" value="">

        <div class="mb-3">
          <label for="nom" class="form-label">Nom de l'année</label>
          <input type="text" class="form-control" id="nom" name="nom" placeholder="Ex: 2024/2025" required>
          <div class="invalid-feedback">Le nom est requis.</div>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Description (optionnel)</label>
          <textarea id="description" name="description" class="form-control" rows="2"></textarea>
        </div>

        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="active" name="active">
          <label class="form-check-label" for="active">Active</label>
        </div>

        <div id="formAlert" class="mt-3"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary" id="saveBtn">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS (bundle incl. Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  const modalEl = document.getElementById('anneeModal');
  const anneeModal = new bootstrap.Modal(modalEl);
  const btnAdd = document.getElementById('btnAdd');
  const anneeForm = document.getElementById('anneeForm');
  const modalTitle = document.getElementById('modalTitle');
  const saveBtn = document.getElementById('saveBtn');
  const formAlert = document.getElementById('formAlert');

  // Ouvrir modal pour ajouter
  btnAdd.addEventListener('click', () => {
    modalTitle.textContent = 'Ajouter une année';
    anneeForm.reset();
    document.getElementById('anneeId').value = '';
    formAlert.innerHTML = '';
    anneeModal.show();
  });

  // Ouvrir modal pour modifier
  document.querySelectorAll('.btn-edit').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      const nom = tr.querySelector('.annee-label').textContent.trim();
      const desc = tr.querySelector('.annee-desc').textContent.trim();
      const activeBadge = tr.querySelector('.annee-statut').textContent.includes('Active');
      modalTitle.textContent = 'Modifier l\'année';
      document.getElementById('anneeId').value = id;
      document.getElementById('nom').value = nom;
      document.getElementById('description').value = desc === '—' ? '' : desc;
      document.getElementById('active').checked = activeBadge;
      formAlert.innerHTML = '';
      anneeModal.show();
    });
  });

  // Suppression simple (confirm)
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const tr = e.target.closest('tr');
      const id = tr.dataset.id;
      if (!confirm('Supprimer cette année ?')) return;
      try {
        const res = await fetch(/annees/${id}/delete/, {
          method: 'POST',
          headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}
        });
        if (res.ok) {
          tr.remove();
        } else {
          alert('Erreur suppression');
        }
      } catch (err) {
        console.error(err);
        alert('Erreur réseau');
      }
    });
  });

  // Soumission formulaire (create / update)
  anneeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    saveBtn.disabled = true;
    formAlert.innerHTML = '';

    const id = document.getElementById('anneeId').value;
    const url = id ? /annees/${id}/update/ : '/annees/create/';
    const formData = new FormData(anneeForm);

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: formData
      });

      const data = await res.json();
      if (res.ok && data.success) {
        // Si create: ajouter ligne ; si update: modifier la ligne existante
        if (!id) {
          // Préparer une nouvelle ligne HTML (simple)
          const tbody = document.querySelector('#anneeTable tbody');
          const newRow = document.createElement('tr');
          newRow.dataset.id = data.annee.id;
          newRow.innerHTML = `
            <td> - </td>
            <td class="annee-label">${data.annee.nom}</td>
            <td class="annee-statut">${data.annee.active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactif</span>'}</td>
            <td class="annee-desc">${data.annee.description || '—'}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-primary btn-edit">Modifier</button>
              <button class="btn btn-sm btn-outline-danger btn-delete">Supprimer</button>
            </td>`;
          tbody.prepend(newRow);
          // (re-attach handlers simply for new buttons)
        } else {
          const tr = document.querySelector(#anneeTable tr[data-id="${id}"]);
          tr.querySelector('.annee-label').textContent = data.annee.nom;
          tr.querySelector('.annee-desc').textContent = data.annee.description || '—';
          tr.querySelector('.annee-statut').innerHTML = data.annee.active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactif</span>';
        }

        anneeModal.hide();
        location.reload(); // option sûre pour mettre à jour (ou mettre à jour DOM manuellement)
      } else {
        // afficher erreurs (si renvoyées en JSON)
        const msg = data.error || 'Erreur serveur. Vérifie les champs.';
        formAlert.innerHTML = <div class="alert alert-danger">${msg}</div>;
      }
    } catch (err) {
      console.error(err);
      formAlert.innerHTML = <div class="alert alert-danger">Erreur réseau.</div>;
    } finally {
      saveBtn.disabled = false;
    }
  });

  // Recherche simple côté client (filtre)
  document.getElementById('searchBtn').addEventListener('click', () => {
    const q = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('#anneeTable tbody tr').forEach(tr => {
      const text = tr.textContent.toLowerCase();
      tr.style.display = text.includes(q) ? '' : 'none';
    });
  });

})();
</script>
</body>
</html>